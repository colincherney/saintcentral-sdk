<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Saint Central SDK - Basic Example</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }

      .container {
        background: white;
        border-radius: 8px;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h1,
      h2 {
        color: #333;
        border-bottom: 2px solid #eee;
        padding-bottom: 10px;
      }

      .section {
        margin-bottom: 30px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: #fafafa;
      }

      .form-group {
        margin-bottom: 15px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
      }

      input,
      textarea {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        box-sizing: border-box;
      }

      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 8px;
        margin-bottom: 8px;
        font-size: 14px;
      }

      button:hover {
        background: #0056b3;
      }

      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }

      .output {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 12px;
        font-family: monospace;
        font-size: 12px;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
        margin-top: 10px;
      }

      .status {
        padding: 8px 12px;
        border-radius: 4px;
        margin-bottom: 15px;
        font-weight: 500;
      }

      .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .status.info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ðŸ”’ Saint Central SDK - Basic Example</h1>
      <div id="connectionStatus" class="status info">Initializing...</div>

      <!-- Authentication Section -->
      <div class="section">
        <h2>Authentication</h2>
        <div class="form-group">
          <label for="email">Email:</label>
          <input type="email" id="email" placeholder="your@email.com" />
        </div>
        <div class="form-group">
          <label for="password">Password:</label>
          <input type="password" id="password" placeholder="Your password" />
        </div>
        <button onclick="signUp()">Sign Up</button>
        <button onclick="signIn()">Sign In</button>
        <button onclick="signOut()">Sign Out</button>
        <button onclick="getSession()">Get Session</button>
        <div id="authOutput" class="output"></div>
      </div>

      <!-- Database Operations on "test" table -->
      <div class="section">
        <h2>Database Operations - "test" table</h2>
        <div class="form-group">
          <label for="testData">Data (JSON):</label>
          <textarea
            id="testData"
            rows="3"
            placeholder='{"name": "John", "value": "example"}'
          ></textarea>
        </div>
        <button onclick="selectFromTest()">Select All</button>
        <button onclick="insertIntoTest()">Insert</button>
        <button onclick="insertIntoTestEncrypted()">Insert (Encrypted)</button>
        <button onclick="updateTestData()">Update</button>
        <button onclick="deleteFromTest()">Delete</button>
        <div id="dbOutput" class="output"></div>
      </div>

      <!-- System Info -->
      <div class="section">
        <h2>System Information</h2>
        <button onclick="checkHealth()">Health Check</button>
        <button onclick="getPlatformInfo()">Platform Info</button>
        <button onclick="getEncryptionInfo()">Encryption Info</button>
        <div id="systemOutput" class="output"></div>
      </div>
    </div>

    <!-- Import the Saint Central SDK -->
    <script type="module">
      // Import the Saint Central SDK
      // Note: You'll need to adjust these import paths based on where you place the SDK files
      import { createClient } from "../sdk/index.js";

      let client = null;
      let currentUser = null;

      // Initialize the client
      async function initializeClient() {
        try {
          log("connectionStatus", "Connecting to Saint Central API...", "info");

          // Create the client with your API endpoint
          client = createClient(
            "https://saint-central-api.colinmcherney.workers.dev",
            {
              enableEncryption: true,
              debug: true, // Enable debug logging
              timeout: 30000,
            }
          );

          // Set up auth state change listener
          client.onAuthStateChange((event, session) => {
            console.log("Auth state changed:", event, session);
            if (event === "SIGNED_IN") {
              currentUser = session?.user || null;
              log("connectionStatus", "Authenticated successfully", "success");
            } else if (event === "SIGNED_OUT") {
              currentUser = null;
              log("connectionStatus", "Signed out", "info");
            }
          });

          // Check initial session
          const session = await client.auth.getSession();
          if (session.data?.session) {
            currentUser = session.data.session.user;
            log("connectionStatus", "Already authenticated", "success");
          } else {
            log("connectionStatus", "Connected - Not authenticated", "info");
          }

          log("authOutput", "Client initialized successfully");
        } catch (error) {
          console.error("Failed to initialize client:", error);
          log(
            "connectionStatus",
            `Connection failed: ${error.message}`,
            "error"
          );
          log("authOutput", `Initialization error: ${error.message}`);
        }
      }

      // Helper function to log messages
      function log(elementId, message, type = null) {
        const element = document.getElementById(elementId);

        if (elementId === "connectionStatus") {
          element.textContent = message;
          element.className = `status ${type || "info"}`;
        } else {
          const timestamp = new Date().toLocaleTimeString();
          element.textContent += `[${timestamp}] ${message}\n`;
          element.scrollTop = element.scrollHeight;
        }
      }

      // Authentication functions
      window.signUp = async () => {
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;

        if (!email || !password) {
          log("authOutput", "Error: Please enter both email and password");
          return;
        }

        if (password.length < 8) {
          log("authOutput", "Error: Password must be at least 8 characters");
          return;
        }

        try {
          log("authOutput", "Signing up...");
          const result = await client.auth.signUp({ email, password });

          if (result.error) {
            log("authOutput", `Sign up error: ${result.error.message}`);
          } else {
            log(
              "authOutput",
              `Sign up successful! User: ${result.data.user?.email}`
            );
            currentUser = result.data.user;
          }
        } catch (error) {
          log("authOutput", `Sign up failed: ${error.message}`);
        }
      };

      window.signIn = async () => {
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;

        if (!email || !password) {
          log("authOutput", "Error: Please enter both email and password");
          return;
        }

        try {
          log("authOutput", "Signing in...");
          const result = await client.auth.signIn({ email, password });

          if (result.error) {
            log("authOutput", `Sign in error: ${result.error.message}`);
          } else {
            log(
              "authOutput",
              `Sign in successful! User: ${result.data.user?.email}`
            );
            currentUser = result.data.user;
          }
        } catch (error) {
          log("authOutput", `Sign in failed: ${error.message}`);
        }
      };

      window.signOut = async () => {
        try {
          log("authOutput", "Signing out...");
          const result = await client.auth.signOut();

          if (result.error) {
            log("authOutput", `Sign out error: ${result.error.message}`);
          } else {
            log("authOutput", "Signed out successfully");
            currentUser = null;
          }
        } catch (error) {
          log("authOutput", `Sign out failed: ${error.message}`);
        }
      };

      window.getSession = async () => {
        try {
          const result = await client.auth.getSession();

          if (result.error) {
            log("authOutput", `Session error: ${result.error.message}`);
          } else if (result.data.session) {
            log(
              "authOutput",
              `Active session for: ${result.data.session.user?.email}`
            );
            currentUser = result.data.session.user;
          } else {
            log("authOutput", "No active session");
            currentUser = null;
          }
        } catch (error) {
          log("authOutput", `Get session failed: ${error.message}`);
        }
      };

      // Database functions for "test" table
      window.selectFromTest = async () => {
        try {
          log("dbOutput", "Selecting from test table...");
          const result = await client.from("test").select("*");

          if (result.error) {
            log("dbOutput", `Select error: ${result.error.message}`);
          } else {
            log(
              "dbOutput",
              `Select result: ${JSON.stringify(result.data, null, 2)}`
            );
          }
        } catch (error) {
          log("dbOutput", `Select failed: ${error.message}`);
        }
      };

      window.insertIntoTest = async () => {
        const dataText = document.getElementById("testData").value.trim();

        if (!dataText) {
          log("dbOutput", "Error: Please enter data to insert");
          return;
        }

        try {
          const data = JSON.parse(dataText);
          log("dbOutput", "Inserting into test table...");

          const result = await client.from("test").insert(data);

          if (result.error) {
            log("dbOutput", `Insert error: ${result.error.message}`);
          } else {
            log(
              "dbOutput",
              `Insert successful: ${JSON.stringify(result.data, null, 2)}`
            );
          }
        } catch (error) {
          if (error instanceof SyntaxError) {
            log("dbOutput", "Error: Invalid JSON format");
          } else {
            log("dbOutput", `Insert failed: ${error.message}`);
          }
        }
      };

      window.insertIntoTestEncrypted = async () => {
        const dataText = document.getElementById("testData").value.trim();

        if (!dataText) {
          log("dbOutput", "Error: Please enter data to insert");
          return;
        }

        try {
          const data = JSON.parse(dataText);
          log("dbOutput", "Inserting encrypted data into test table...");

          // Use the .encrypt() chain for encrypted insertion
          const result = await client.from("test").insert(data).encrypt();

          if (result.error) {
            log("dbOutput", `Encrypted insert error: ${result.error.message}`);
          } else {
            log(
              "dbOutput",
              `Encrypted insert successful: ${JSON.stringify(
                result.data,
                null,
                2
              )}`
            );
          }
        } catch (error) {
          if (error instanceof SyntaxError) {
            log("dbOutput", "Error: Invalid JSON format");
          } else {
            log("dbOutput", `Encrypted insert failed: ${error.message}`);
          }
        }
      };

      window.updateTestData = async () => {
        const dataText = document.getElementById("testData").value.trim();

        if (!dataText) {
          log("dbOutput", "Error: Please enter data to update");
          return;
        }

        try {
          const data = JSON.parse(dataText);
          log("dbOutput", "Updating test table...");

          // Update first record as example
          const result = await client.from("test").update(data).eq("id", 1);

          if (result.error) {
            log("dbOutput", `Update error: ${result.error.message}`);
          } else {
            log(
              "dbOutput",
              `Update successful: ${JSON.stringify(result.data, null, 2)}`
            );
          }
        } catch (error) {
          if (error instanceof SyntaxError) {
            log("dbOutput", "Error: Invalid JSON format");
          } else {
            log("dbOutput", `Update failed: ${error.message}`);
          }
        }
      };

      window.deleteFromTest = async () => {
        try {
          log("dbOutput", "Deleting from test table (where id = 1)...");

          const result = await client.from("test").delete().eq("id", 1);

          if (result.error) {
            log("dbOutput", `Delete error: ${result.error.message}`);
          } else {
            log("dbOutput", "Delete successful");
          }
        } catch (error) {
          log("dbOutput", `Delete failed: ${error.message}`);
        }
      };

      // System information functions
      window.checkHealth = async () => {
        try {
          log("systemOutput", "Checking system health...");
          const result = await client.healthCheck();
          log(
            "systemOutput",
            `Health check: ${JSON.stringify(result, null, 2)}`
          );
        } catch (error) {
          log("systemOutput", `Health check failed: ${error.message}`);
        }
      };

      window.getPlatformInfo = () => {
        try {
          const info = client.getPlatformInfo();
          log(
            "systemOutput",
            `Platform info: ${JSON.stringify(info, null, 2)}`
          );
        } catch (error) {
          log("systemOutput", `Platform info failed: ${error.message}`);
        }
      };

      window.getEncryptionInfo = () => {
        try {
          // Access encryption manager through client internals
          const encryptionInfo = client
            ._getManagers()
            .encryption.getEncryptionInfo();
          log(
            "systemOutput",
            `Encryption info: ${JSON.stringify(encryptionInfo, null, 2)}`
          );
        } catch (error) {
          log("systemOutput", `Encryption info failed: ${error.message}`);
        }
      };

      // Initialize when page loads
      document.addEventListener("DOMContentLoaded", initializeClient);

      // Make client available globally for debugging
      window.saintCentralClient = () => client;
    </script>
  </body>
</html>
