<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Saint Central Auth Test</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }

      .container {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #555;
      }

      input {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 16px;
        box-sizing: border-box;
      }

      input:focus {
        outline: none;
        border-color: #007bff;
      }

      .button-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin: 20px 0;
      }

      button {
        padding: 12px 20px;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-primary {
        background: #007bff;
        color: white;
      }

      .btn-primary:hover {
        background: #0056b3;
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background: #545b62;
      }

      .btn-danger {
        background: #dc3545;
        color: white;
        grid-column: span 2;
      }

      .btn-danger:hover {
        background: #c82333;
      }

      .output {
        margin-top: 20px;
        padding: 15px;
        border-radius: 6px;
        font-family: monospace;
        font-size: 14px;
        white-space: pre-wrap;
        min-height: 100px;
        border: 2px solid #ddd;
      }

      .success {
        background: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
      }

      .error {
        background: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
      }

      .info {
        background: #d1ecf1;
        border-color: #bee5eb;
        color: #0c5460;
      }

      .status {
        text-align: center;
        padding: 10px;
        margin: 10px 0;
        border-radius: 6px;
        font-weight: 500;
      }

      .loading {
        opacity: 0.6;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîê Saint Central Auth Test</h1>

      <div class="status info" style="margin-bottom: 20px">
        üîí <strong>Production Encryption</strong> - Secure key exchange with
        session-specific AES-256-GCM encryption
      </div>

      <div
        class="status"
        style="
          margin-bottom: 20px;
          background: #d4edda;
          border-color: #c3e6cb;
          color: #155724;
        "
      >
        ‚úÖ <strong>Production Ready</strong> - Using secure key exchange
        protocol with session-based encryption keys.
      </div>

      <div
        class="status"
        style="
          margin-bottom: 20px;
          background: #fff3cd;
          border-color: #ffeaa7;
          color: #856404;
        "
      >
        üåê
        <strong>Worker URL:</strong>
        https://saint-central-api.colinmcherney.workers.dev
        <br />
        üìù <strong>Debug:</strong> Open browser DevTools (F12) ‚Üí Console tab to
        see detailed network logs
      </div>

      <div class="form-group">
        <label for="email">Email Address</label>
        <input
          id="email"
          type="email"
          placeholder="test@example.com"
          value="test@example.com"
        />
      </div>

      <div class="form-group">
        <label for="password">Password</label>
        <input
          id="password"
          type="password"
          placeholder="Enter password"
          value="TestPassword123!"
        />
      </div>

      <div class="button-group">
        <button class="btn-primary" onclick="signUp()">Sign Up</button>
        <button class="btn-primary" onclick="signIn()">Sign In</button>
        <button class="btn-secondary" onclick="getSession()">
          Get Session
        </button>
        <button class="btn-secondary" onclick="refreshSession()">
          Refresh Token
        </button>
        <button
          class="btn-secondary"
          onclick="testEncryption()"
          style="grid-column: span 2"
        >
          üîí Test Encryption
        </button>
        <button
          class="btn-secondary"
          onclick="testKeyExchange()"
          style="grid-column: span 2"
        >
          üîë Test Key Exchange
        </button>
        <button
          class="btn-secondary"
          onclick="testConnectivity()"
          style="grid-column: span 2"
        >
          üåê Test Connectivity
        </button>
        <button
          class="btn-secondary"
          onclick="testManualAuth()"
          style="grid-column: span 2"
        >
          üîß Manual Auth Test
        </button>
        <button
          class="btn-secondary"
          onclick="testEncryptedVsUnencrypted()"
          style="grid-column: span 2"
        >
          üîê Test Encrypted vs Unencrypted
        </button>
        <button
          class="btn-secondary"
          onclick="testWithLongerTimeout()"
          style="grid-column: span 2"
        >
          ‚è±Ô∏è Test with Longer Timeout
        </button>
        <button
          class="btn-secondary"
          onclick="debugEncryption()"
          style="grid-column: span 2"
        >
          üîç Debug Encryption Config
        </button>
        <button class="btn-danger" onclick="signOut()">Sign Out</button>
      </div>

      <div id="status" class="status"></div>
      <div id="output" class="output info">Ready to test authentication...</div>
    </div>

    <script type="module">
      import { createClient } from "./src/sdk.js";

      // Initialize client with your worker URL
      const client = createClient(
        "https://saint-central-api.colinmcherney.workers.dev",
        {
          security: {
            encryption: true,
            rateLimit: true,
            jwtHardening: true,
            headerSecurity: true,
            autoTokenRefresh: true,
          },
          config: {
            requestTimeout: 15000,
            maxRetries: 3,
            retryDelay: 1000,
          },
        }
      );

      const $ = (id) => document.getElementById(id);

      function setStatus(message, type = "info") {
        const status = $("status");
        status.textContent = message;
        status.className = `status ${type}`;
      }

      function log(data, type = "info") {
        const output = $("output");
        output.className = `output ${type}`;

        if (typeof data === "object") {
          // Enhanced logging for debugging encryption issues
          const logData = {
            timestamp: new Date().toISOString(),
            ...data,
          };
          output.textContent = JSON.stringify(logData, null, 2);
        } else {
          output.textContent = `[${new Date().toISOString()}] ${data}`;
        }
      }

      function handleError(error, operation) {
        console.error(`${operation} error:`, error);

        // Enhanced error handling for encryption issues
        if (error.code === "DECRYPTION_ERROR") {
          setStatus(`${operation} failed - Server decryption error`, "error");
          log(
            {
              operation,
              error: "Server failed to decrypt the request",
              message: error.message,
              details: error.details,
              suggestion:
                "Client and server may be using different encryption keys",
            },
            "error"
          );
        } else if (error.code === "ENCRYPTION_ERROR") {
          setStatus(`${operation} failed - Client encryption error`, "error");
          log(
            {
              operation,
              error: "Client failed to encrypt the request",
              message: error.message,
              suggestion: "Check if encryption keys are properly configured",
            },
            "error"
          );
        } else if (error.code === "NETWORK_ERROR") {
          setStatus(`${operation} failed - Network error`, "error");
          log(
            {
              operation,
              error: "Network request failed",
              message: error.message,
              suggestion: "Check your internet connection and server URL",
            },
            "error"
          );
        } else if (error.code === "TIMEOUT") {
          setStatus(`${operation} failed - Request timeout`, "error");
          log(
            {
              operation,
              error: "Request timed out",
              message: error.message,
              suggestion:
                "Server may be slow or encryption is taking longer than expected",
            },
            "error"
          );
        } else {
          setStatus(`${operation} failed`, "error");
          log(
            {
              operation,
              error: error.message || "Unknown error",
              code: error.code,
              status: error.status,
              details: error.details,
            },
            "error"
          );
        }
      }

      function setLoading(loading) {
        document.body.classList.toggle("loading", loading);
      }

      async function signUp() {
        try {
          setLoading(true);
          setStatus("Ensuring secure connection...", "info");

          // Ensure client is ready
          await client.utils.ready();

          setStatus("Creating account with encrypted payload...", "info");

          const email = $("email").value;
          const password = $("password").value;

          if (!email || !password) {
            throw new Error("Please enter both email and password");
          }

          const { data, error } = await client.auth.signUp({
            email,
            password,
          });

          if (error) {
            handleError(error, "Sign Up");
          } else {
            setStatus("Account created successfully!", "success");
            log(
              {
                operation: "Sign Up",
                status: "success",
                user: data?.user,
                session: data?.session
                  ? "Session created"
                  : "No session (check email for confirmation)",
                encryption: "Payload was encrypted",
              },
              "success"
            );
          }
        } catch (err) {
          handleError(err, "Sign Up");
        } finally {
          setLoading(false);
        }
      }

      async function signIn() {
        try {
          setLoading(true);
          setStatus("Ensuring secure connection...", "info");

          // Ensure client is ready
          const readyStatus = await client.utils.ready();
          console.log("Client ready status:", readyStatus);

          setStatus("Signing in with encrypted credentials...", "info");

          const email = $("email").value;
          const password = $("password").value;

          if (!email || !password) {
            throw new Error("Please enter both email and password");
          }

          console.log("Attempting sign in with:", {
            email,
            passwordLength: password.length,
          });
          console.log("Client session ID:", readyStatus.sessionId);
          console.log(
            "Client encryption config:",
            client.security.getEncryptionConfig()
          );

          // Add detailed logging before the actual request
          console.log("About to call client.auth.signInWithPassword...");

          const { data, error } = await client.auth.signInWithPassword({
            email,
            password,
          });

          console.log("Sign in response:", { data, error });

          if (error) {
            handleError(error, "Sign In");
          } else {
            setStatus("Signed in successfully!", "success");
            log(
              {
                operation: "Sign In",
                status: "success",
                user: {
                  id: data?.user?.id,
                  email: data?.user?.email,
                  created_at: data?.user?.created_at,
                },
                session: {
                  access_token: data?.access_token ? "Present" : "Missing",
                  refresh_token: data?.refresh_token ? "Present" : "Missing",
                  expires_at: data?.expires_at,
                },
                encryption: "Credentials were encrypted",
              },
              "success"
            );
          }
        } catch (err) {
          console.error("Sign in error details:", err);
          console.error("Error stack:", err.stack);

          // Enhanced error logging
          if (err.originalError) {
            console.error("Original error:", err.originalError);
          }

          // Log the exact error details
          console.error("Error properties:", {
            name: err.name,
            message: err.message,
            code: err.code,
            status: err.status,
            details: err.details,
          });

          handleError(err, "Sign In");
        } finally {
          setLoading(false);
        }
      }

      async function signOut() {
        try {
          setLoading(true);
          setStatus("Signing out...", "info");

          const { error } = await client.auth.signOut();

          if (error) {
            handleError(error, "Sign Out");
          } else {
            setStatus("Signed out successfully", "success");
            log(
              {
                operation: "Sign Out",
                status: "success",
                message: "Successfully signed out",
              },
              "success"
            );
          }
        } catch (err) {
          handleError(err, "Sign Out");
        } finally {
          setLoading(false);
        }
      }

      async function getSession() {
        try {
          setLoading(true);
          setStatus("Checking session...", "info");

          const { data, error } = await client.auth.getSession();

          if (error) {
            handleError(error, "Get Session");
          } else if (data?.session) {
            setStatus("Active session found", "success");
            log(
              {
                operation: "Get Session",
                status: "success",
                user: {
                  id: data.session.user?.id,
                  email: data.session.user?.email,
                  last_sign_in: data.session.user?.last_sign_in_at,
                },
                session: {
                  expires_at: data.session.expires_at,
                  token_type: data.session.token_type,
                },
              },
              "success"
            );
          } else {
            setStatus("No active session", "info");
            log(
              {
                operation: "Get Session",
                status: "no_session",
                message: "No active session found",
              },
              "info"
            );
          }
        } catch (err) {
          handleError(err, "Get Session");
        } finally {
          setLoading(false);
        }
      }

      async function refreshSession() {
        try {
          setLoading(true);
          setStatus("Refreshing session...", "info");

          const { data, error } = await client.auth.refreshSession();

          if (error) {
            handleError(error, "Refresh Session");
          } else {
            setStatus("Session refreshed successfully", "success");
            log(
              {
                operation: "Refresh Session",
                status: "success",
                new_access_token: data?.access_token ? "Generated" : "Missing",
                expires_at: data?.expires_at,
              },
              "success"
            );
          }
        } catch (err) {
          handleError(err, "Refresh Session");
        } finally {
          setLoading(false);
        }
      }

      async function testEncryption() {
        try {
          setLoading(true);
          setStatus("Ensuring client is ready...", "info");

          // Ensure client is ready
          await client.utils.ready();

          setStatus("Testing encryption utilities...", "info");

          const testData = {
            message: "Hello, Saint Central!",
            timestamp: Date.now(),
            email: $("email").value,
          };

          // Test encryption
          const encrypted = await client.utils.encrypt(testData);

          // Test decryption
          const decrypted = await client.utils.decrypt(encrypted);

          setStatus("Encryption test successful!", "success");
          log(
            {
              operation: "Test Encryption",
              status: "success",
              original_data: testData,
              encrypted_format: {
                version: encrypted.version,
                algorithm: encrypted.algorithm,
                encrypted: encrypted.encrypted,
                data_length: encrypted.data.length,
              },
              decrypted_data: decrypted,
              encryption_working:
                JSON.stringify(testData) === JSON.stringify(decrypted),
            },
            "success"
          );
        } catch (err) {
          handleError(err, "Test Encryption");
        } finally {
          setLoading(false);
        }
      }

      async function testKeyExchange() {
        try {
          setLoading(true);
          setStatus("Testing key exchange...", "info");

          const testData = {
            message: "Hello, Saint Central!",
            timestamp: Date.now(),
            email: $("email").value,
          };

          // Test key exchange
          const keyExchangeResult = await client.security.testKeyExchange(
            testData
          );

          setStatus("Key exchange test successful!", "success");
          log(
            {
              operation: "Test Key Exchange",
              status: "success",
              original_data: testData,
              key_exchange_result: keyExchangeResult,
            },
            "success"
          );
        } catch (err) {
          handleError(err, "Test Key Exchange");
        } finally {
          setLoading(false);
        }
      }

      async function testConnectivity() {
        try {
          setLoading(true);
          setStatus("Testing connectivity...", "info");

          // Test basic connectivity first
          console.log("Testing basic connectivity to worker...");

          try {
            const basicResponse = await fetch(
              "https://saint-central-api.colinmcherney.workers.dev/",
              {
                method: "GET",
                headers: {
                  "Content-Type": "application/json",
                },
              }
            );

            console.log("Basic response status:", basicResponse.status);
            console.log(
              "Basic response headers:",
              Object.fromEntries(basicResponse.headers.entries())
            );

            if (basicResponse.ok) {
              const basicData = await basicResponse.json();
              console.log("Basic response data:", basicData);
            } else {
              console.error("Basic response not OK:", basicResponse.statusText);
            }
          } catch (basicError) {
            console.error("Basic connectivity test failed:", basicError);
            throw new Error(`Basic connectivity failed: ${basicError.message}`);
          }

          // Test using the SDK's connectivity test
          const connectivityResult = await client.utils.testConnectivity();
          console.log("SDK connectivity result:", connectivityResult);

          setStatus("Connectivity test successful!", "success");
          log(
            {
              operation: "Test Connectivity",
              status: "success",
              result: connectivityResult,
            },
            "success"
          );
        } catch (err) {
          console.error("Connectivity test error:", err);
          handleError(err, "Test Connectivity");
        } finally {
          setLoading(false);
        }
      }

      async function testManualAuth() {
        try {
          setLoading(true);
          setStatus("Testing manual authentication...", "info");

          const email = $("email").value;
          const password = $("password").value;

          if (!email || !password) {
            throw new Error("Please enter both email and password");
          }

          console.log("Attempting manual authentication with:", {
            email,
            passwordLength: password.length,
          });

          const manualAuthResult = await client.auth.testManualAuth({
            email,
            password,
          });

          setStatus("Manual authentication test successful!", "success");
          log(
            {
              operation: "Test Manual Auth",
              status: "success",
              result: manualAuthResult,
            },
            "success"
          );
        } catch (err) {
          handleError(err, "Test Manual Auth");
        } finally {
          setLoading(false);
        }
      }

      async function testEncryptedVsUnencrypted() {
        try {
          setLoading(true);
          setStatus("Testing encrypted vs unencrypted sign-in...", "info");

          const email = $("email").value;
          const password = $("password").value;

          if (!email || !password) {
            throw new Error("Please enter both email and password");
          }

          // Test 1: With encryption enabled (current state)
          console.log("üîí Test 1: Attempting sign-in WITH encryption...");
          let encryptedResult;
          try {
            encryptedResult = await client.auth.signInWithPassword({
              email,
              password,
            });
            console.log("‚úÖ Encrypted sign-in result:", encryptedResult);
          } catch (encryptedError) {
            console.error("‚ùå Encrypted sign-in failed:", encryptedError);
            encryptedResult = { error: encryptedError.message };
          }

          // Test 2: Temporarily disable encryption
          console.log("üîì Test 2: Attempting sign-in WITHOUT encryption...");
          const originalEncryption = client.security.status().encryption;
          client.security.configure({ encryption: false });

          let unencryptedResult;
          try {
            unencryptedResult = await client.auth.signInWithPassword({
              email,
              password,
            });
            console.log("‚úÖ Unencrypted sign-in result:", unencryptedResult);
          } catch (unencryptedError) {
            console.error("‚ùå Unencrypted sign-in failed:", unencryptedError);
            unencryptedResult = { error: unencryptedError.message };
          }

          // Restore original encryption setting
          client.security.configure({ encryption: originalEncryption });

          setStatus(
            "Encrypted vs unencrypted comparison completed!",
            "success"
          );
          log(
            {
              operation: "Test Encrypted vs Unencrypted",
              status: "completed",
              encrypted_result: encryptedResult,
              unencrypted_result: unencryptedResult,
              comparison: {
                encrypted_success: !encryptedResult.error,
                unencrypted_success: !unencryptedResult.error,
                issue_is_encryption:
                  !encryptedResult.error && !!unencryptedResult.error,
              },
            },
            "success"
          );
        } catch (err) {
          handleError(err, "Test Encrypted vs Unencrypted");
        } finally {
          setLoading(false);
        }
      }

      async function testWithLongerTimeout() {
        try {
          setLoading(true);
          setStatus("Testing sign-in with a longer timeout...", "info");

          const email = $("email").value;
          const password = $("password").value;

          if (!email || !password) {
            throw new Error("Please enter both email and password");
          }

          console.log("Attempting sign-in with 60-second timeout...");

          const longerTimeoutResult = await client.auth.testWithTimeout(
            {
              email,
              password,
            },
            60000
          ); // 60 seconds

          setStatus("Sign-in with longer timeout completed!", "success");
          log(
            {
              operation: "Test with Longer Timeout",
              status: "success",
              result: longerTimeoutResult,
            },
            "success"
          );
        } catch (err) {
          handleError(err, "Test with Longer Timeout");
        } finally {
          setLoading(false);
        }
      }

      async function debugEncryption() {
        try {
          setLoading(true);
          setStatus("Getting encryption configuration...", "info");

          const config = await client.security.getEncryptionConfig();

          setStatus(
            "Encryption configuration retrieved successfully!",
            "success"
          );
          log(
            {
              operation: "Get Encryption Config",
              status: "success",
              config: config,
            },
            "success"
          );
        } catch (err) {
          handleError(err, "Get Encryption Config");
        } finally {
          setLoading(false);
        }
      }

      // Auto-check session on load
      window.addEventListener("load", () => {
        setTimeout(getSession, 500);
      });

      // Attach functions globally for buttons
      window.signUp = signUp;
      window.signIn = signIn;
      window.signOut = signOut;
      window.getSession = getSession;
      window.refreshSession = refreshSession;
      window.testEncryption = testEncryption;
      window.testKeyExchange = testKeyExchange;
      window.testConnectivity = testConnectivity;
      window.testManualAuth = testManualAuth;
      window.testEncryptedVsUnencrypted = testEncryptedVsUnencrypted;
      window.testWithLongerTimeout = testWithLongerTimeout;
      window.debugEncryption = debugEncryption;
    </script>
  </body>
</html>
